<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rezero.anyotherday.report.dao.ReportDao">

    <insert id="createReport"
      parameterType="com.rezero.anyotherday.report.dto.ReportDto"
      useGeneratedKeys="true"
      keyProperty="reportId">
        INSERT INTO ai_report (record_id, analysis_result)
        VALUES (#{recordId}, #{analysisResult})
    </insert>

    <select id="getReportById"
      parameterType="Integer"
      resultType="com.rezero.anyotherday.report.dto.ReportDto">
        SELECT report_id, record_id, analysis_result, created_at, updated_at
        FROM ai_report
        WHERE report_id = #{reportId}
    </select>

    <select id="getReportByRecordId"
      parameterType="Integer"
      resultType="com.rezero.anyotherday.report.dto.ReportDto">
        SELECT report_id, record_id, analysis_result, created_at, updated_at
        FROM ai_report
        WHERE record_id = #{recordId}
    </select>

    <select id="getReportsByWardId"
      parameterType="Integer"
      resultType="com.rezero.anyotherday.report.dto.ReportDto">
        SELECT ar.report_id, ar.record_id, ar.analysis_result, ar.created_at, ar.updated_at
        FROM ai_report ar
                 JOIN audio_record aud ON ar.record_id = aud.record_id
        WHERE aud.ward_id = #{wardId}
        ORDER BY ar.created_at DESC
    </select>

    <update id="updateReport"
      parameterType="com.rezero.anyotherday.report.dto.ReportDto">
        UPDATE ai_report
        SET analysis_result = #{analysisResult},
            updated_at = #{updatedAt}
        WHERE report_id = #{reportId}
    </update>

    <delete id="deleteReport" parameterType="Integer">
        DELETE FROM ai_report
        WHERE report_id = #{reportId}
    </delete>

    <select id="getRecentReports"
      parameterType="Integer"
      resultType="com.rezero.anyotherday.report.dto.ReportDto">
        SELECT report_id, record_id, analysis_result, created_at, updated_at
        FROM ai_report
        ORDER BY created_at DESC
            LIMIT #{limit}
    </select>

</mapper>
