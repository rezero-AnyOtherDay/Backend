<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rezero.anyotherday.report.dao.ReportDao">

    <!-- AI 레포트 생성 -->
    <insert id="createReport"
      parameterType="com.rezero.anyotherday.report.dto.ReportDto"
      useGeneratedKeys="true"
      keyProperty="reportId">
        INSERT INTO ai_report (record_id, analysis_result, summary)
        VALUES (#{recordId}, #{analysisResult}, #{summary})
    </insert>

    <!-- 레포트 ID로 단건 조회 -->
    <select id="getReportById"
      parameterType="int"
      resultType="com.rezero.anyotherday.report.dto.ReportDto">
        SELECT
            report_id   AS reportId,
            record_id   AS recordId,
            analysis_result AS analysisResult,
            summary     AS summary,
            created_at  AS createdAt,
            updated_at  AS updatedAt
        FROM ai_report
        WHERE report_id = #{reportId}
    </select>

    <!-- 피보호자의 모든 레포트 조회 (최신 순) -->
    <select id="getReportsByWardId"
      parameterType="int"
      resultType="com.rezero.anyotherday.report.dto.ReportDto">
        SELECT
            ar.report_id      AS reportId,
            ar.record_id      AS recordId,
            ar.analysis_result AS analysisResult,
            ar.summary        AS summary,
            ar.created_at     AS createdAt,
            ar.updated_at     AS updatedAt
        FROM ai_report ar
                 JOIN audio_record aud ON ar.record_id = aud.record_id
        WHERE aud.ward_id = #{wardId}
        ORDER BY ar.created_at DESC
    </select>

    <!-- 피보호자의 가장 최근 레포트 1개 조회 -->
    <select id="getLatestReportByWardId"
      parameterType="int"
      resultType="com.rezero.anyotherday.report.dto.ReportDto">
        SELECT
            ar.report_id      AS reportId,
            ar.record_id      AS recordId,
            ar.analysis_result AS analysisResult,
            ar.summary        AS summary,
            ar.created_at     AS createdAt,
            ar.updated_at     AS updatedAt
        FROM ai_report ar
                 JOIN audio_record aud ON ar.record_id = aud.record_id
        WHERE aud.ward_id = #{wardId}
        ORDER BY ar.created_at DESC
        LIMIT 1
    </select>

    <!-- 피보호자의 최근 N개 레포트 조회 (RAG용 히스토리) -->
    <select id="getRecentReportsByWard"
      resultType="com.rezero.anyotherday.report.dto.ReportDto">
        SELECT
            ar.report_id      AS reportId,
            ar.record_id      AS recordId,
            ar.analysis_result AS analysisResult,
            ar.summary        AS summary,
            ar.created_at     AS createdAt,
            ar.updated_at     AS updatedAt
        FROM ai_report ar
                 JOIN audio_record aud ON ar.record_id = aud.record_id
        WHERE aud.ward_id = #{wardId}
        ORDER BY ar.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 오디오 레코드 ID로 레포트 조회 -->
    <select id="getReportByRecordId"
      parameterType="int"
      resultType="com.rezero.anyotherday.report.dto.ReportDto">
        SELECT
            report_id       AS reportId,
            record_id       AS recordId,
            analysis_result AS analysisResult,
            summary         AS summary,
            created_at      AS createdAt,
            updated_at      AS updatedAt
        FROM ai_report
        WHERE record_id = #{recordId}
    </select>

</mapper>